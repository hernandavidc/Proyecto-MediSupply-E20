upstream user_service {
    server medisupply-user-service:8000;
}

upstream supplier_service {
    server medisupply-supplier-service:8000;
}

upstream client_service {
    server medisupply-client-service:8000;
}

upstream order_service {
    server medisupply-order-service:8000;
}

server {
    listen 8080;
    server_name localhost;

    # Configurar el puerto correcto para redirects
    port_in_redirect on;
    absolute_redirect off;

    # Corregir redirects del backend para incluir el puerto
    proxy_redirect http://localhost/ http://localhost:8080/;
    proxy_redirect http://$host/ http://$host:8080/;

    # Ocultar headers CORS del backend para evitar duplicados
    proxy_hide_header 'Access-Control-Allow-Origin';
    proxy_hide_header 'Access-Control-Allow-Methods';
    proxy_hide_header 'Access-Control-Allow-Headers';
    proxy_hide_header 'Access-Control-Allow-Credentials';

    # Configuración de CORS centralizada en el gateway
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;
    add_header 'Access-Control-Max-Age' 1728000 always;

    # === USER SERVICE ENDPOINTS ===
    # Rutas de autenticación y usuarios
    location /api/v1/users {
        proxy_pass http://user_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /docs {
        proxy_pass http://user_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /openapi.json {
        proxy_pass http://user_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # === CLIENT SERVICE ENDPOINTS ===
    # Rutas de clientes
    location /api/v1/clientes {
        # Agregar trailing slash automáticamente
        rewrite ^(/api/v1/clientes)$ $1/ last;
        proxy_pass http://client_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # === SUPPLIER SERVICE ENDPOINTS ===
    # Catálogos - Paises
    location /api/v1/paises {
        proxy_pass http://supplier_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Certificaciones
    location /api/v1/certificaciones {
        proxy_pass http://supplier_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Categorías de suministros
    location /api/v1/categorias-suministros {
        proxy_pass http://supplier_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proveedores
    location /api/v1/proveedores {
        # Agregar trailing slash automáticamente
        rewrite ^(/api/v1/proveedores)$ $1/ last;
        proxy_pass http://supplier_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Productos
    location /api/v1/productos {
        # Agregar trailing slash automáticamente
        rewrite ^(/api/v1/productos)$ $1/ last;
        proxy_pass http://supplier_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Vendedores
    location /api/v1/vendedores {
        proxy_pass http://supplier_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Planes de venta
    location /api/v1/planes-venta {
        proxy_pass http://supplier_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Reportes
    location /api/v1/reportes {
        proxy_pass http://supplier_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Visitas
    location /api/v1/visitas {
        proxy_pass http://supplier_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # === ORDER SERVICE ENDPOINTS ===
    # Ordenes
    location /api/v1/ordenes {
        proxy_pass http://order_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Vehiculos
    location /api/v1/vehiculos {
        proxy_pass http://order_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Orden-Productos
    location /api/v1/orden-productos {
        proxy_pass http://order_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Bodegas
    location /api/v1/bodegas {
        proxy_pass http://order_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Bodega-Productos
    location /api/v1/bodega-productos {
        proxy_pass http://order_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Novedades
    location /api/v1/novedades {
        proxy_pass http://order_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Documentación de order service
    location /order-docs {
        proxy_pass http://order_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /order-redoc {
        proxy_pass http://order_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /order-openapi.json {
        proxy_pass http://order_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Documentación de supplier service
    location /supplier-docs {
        proxy_pass http://supplier_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /supplier-redoc {
        proxy_pass http://supplier_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /supplier-openapi.json {
        proxy_pass http://supplier_service$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Health checks de cada servicio
    location /healthz {
        proxy_pass http://supplier_service$request_uri;
        proxy_set_header Host $host;
    }

    location = /health {
        # Determinar a qué servicio enviar según el contexto
        # Por defecto, health check del gateway
        access_log off;
        return 200 "API Gateway Healthy\n";
        add_header Content-Type text/plain;
    }

    # Página de bienvenida
    location = / {
        return 200 '{
            "message": "MediSupply API Gateway",
            "version": "2.0.0",
            "description": "Gateway unificado - Sin prefijos de servicio",
            "endpoints": {
                "users": "/api/v1/users",
                "clientes": "/api/v1/clientes",
                "proveedores": "/api/v1/proveedores",
                "productos": "/api/v1/productos",
                "vendedores": "/api/v1/vendedores",
                "planes_venta": "/api/v1/planes-venta",
                "reportes": "/api/v1/reportes",
                "visitas": "/api/v1/visitas",
                "paises": "/api/v1/paises",
                "certificaciones": "/api/v1/certificaciones",
                "categorias": "/api/v1/categorias-suministros",
                "ordenes": "/api/v1/ordenes",
                "vehiculos": "/api/v1/vehiculos",
                "orden_productos": "/api/v1/orden-productos",
                "bodegas": "/api/v1/bodegas",
                "bodega_productos": "/api/v1/bodega-productos",
                "novedades": "/api/v1/novedades"
            },
            "docs": {
                "users": "/docs",
                "suppliers": "/supplier-docs",
                "orders": "/order-docs"
            },
            "health": "/health"
        }';
        add_header Content-Type application/json;
    }
}
