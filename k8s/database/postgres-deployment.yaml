apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-deployment
  namespace: medisupply
  labels:
    app: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:15-alpine
        ports:
        - containerPort: 5432
        envFrom:
        - secretRef:
            name: postgres-secret
        env:
        - name: POSTGRES_INITDB_ARGS
          value: "--encoding=UTF-8"
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
          subPath: pgdata
        - name: init-scripts
          mountPath: /docker-entrypoint-initdb.d
        resources:
          requests:
            memory: "1.5Gi"
            cpu: "1000m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        livenessProbe:
          exec:
            command:
              - pg_isready
              - -U
              - mediadmin
              - -d
              - users_db
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 3
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
              - pg_isready
              - -U
              - mediadmin
              - -d
              - users_db
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 2
          failureThreshold: 2
      - name: db-init-sidecar
        image: postgres:15-alpine
        command:
          - /bin/sh
          - -c
          - |
            echo "‚è≥ Iniciando sidecar de inicializaci√≥n de bases de datos..."
            
            # Funci√≥n auxiliar para crear base de datos si no existe (idempotente)
            create_db_if_not_exists() {
              local db_name=$1
              echo "Verificando $db_name..."
              DB_EXISTS=$(PGPASSWORD="$POSTGRES_PASSWORD" psql -h localhost -p 5432 -U mediadmin -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='$db_name'" 2>/dev/null || echo "")
              if [ "$DB_EXISTS" = "1" ]; then
                echo "‚úÖ $db_name ya existe, omitiendo creaci√≥n"
              else
                echo "üì¶ Creando $db_name..."
                PGPASSWORD="$POSTGRES_PASSWORD" psql -h localhost -p 5432 -U mediadmin -d postgres -c "CREATE DATABASE $db_name;" 2>&1
                if [ $? -eq 0 ]; then
                  echo "‚úÖ $db_name creada exitosamente"
                else
                  echo "‚ö†Ô∏è  Error al crear $db_name (puede que ya exista)"
                fi
              fi
            }
            
            # Funci√≥n auxiliar para crear extensi√≥n si no existe (idempotente)
            create_extension_if_not_exists() {
              local db_name=$1
              echo "Verificando extensi√≥n uuid-ossp en $db_name..."
              PGPASSWORD="$POSTGRES_PASSWORD" psql -h localhost -p 5432 -U mediadmin -d "$db_name" -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";" >/dev/null 2>&1
              if [ $? -eq 0 ]; then
                echo "‚úÖ Extensi√≥n uuid-ossp en $db_name"
              else
                echo "‚ö†Ô∏è  Error al crear extensi√≥n en $db_name"
              fi
            }
            
            # Esperar hasta que PostgreSQL est√© listo
            echo "‚è≥ Esperando a que PostgreSQL est√© listo..."
            MAX_RETRIES=60
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if pg_isready -h localhost -p 5432 -U mediadmin -d postgres 2>/dev/null; then
                echo "‚úÖ PostgreSQL est√° listo"
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $((RETRY_COUNT % 5)) -eq 0 ]; then
                echo "PostgreSQL no est√° listo, esperando... (intento $RETRY_COUNT/$MAX_RETRIES)"
              fi
              sleep 2
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "‚ö†Ô∏è  PostgreSQL no est√° listo despu√©s de $MAX_RETRIES intentos, continuando de todas formas..."
            fi
            
            # Crear bases de datos si no existen
            echo "‚è≥ Verificando y creando bases de datos si no existen..."
            create_db_if_not_exists "suppliers_db"
            create_db_if_not_exists "users_db"
            create_db_if_not_exists "clients_db"
            
            # Crear extensiones en cada base de datos
            echo "‚è≥ Creando extensiones..."
            create_extension_if_not_exists "suppliers_db"
            create_extension_if_not_exists "users_db"
            create_extension_if_not_exists "clients_db"
            
            echo ""
            echo "‚úÖ Inicializaci√≥n de bases de datos completada"
            echo "‚úÖ Sidecar completado, saliendo..."
        envFrom:
        - secretRef:
            name: postgres-secret
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      volumes:
      - name: postgres-storage
        emptyDir:
          sizeLimit: 4Gi
      - name: init-scripts
        configMap:
          name: postgres-init-scripts
