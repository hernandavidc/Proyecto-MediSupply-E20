name: Deploy to GKE

on:
  push:
    branches: [main]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: medisupply-cluster
  GKE_REGION: us-central1
  REGISTRY: us-central1-docker.pkg.dev

jobs:
  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for Artifact Registry
      run: gcloud --quiet auth configure-docker us-central1-docker.pkg.dev

    - name: Get GKE credentials
      run: gcloud container clusters get-credentials $GKE_CLUSTER --region $GKE_REGION

    - name: Build and push user-service image
      run: |
        # Build image
        docker build -t $REGISTRY/$PROJECT_ID/medisupply/user-service:$GITHUB_SHA ./user-service
        docker tag $REGISTRY/$PROJECT_ID/medisupply/user-service:$GITHUB_SHA $REGISTRY/$PROJECT_ID/medisupply/user-service:latest
        
        # Push image
        docker push $REGISTRY/$PROJECT_ID/medisupply/user-service:$GITHUB_SHA
        docker push $REGISTRY/$PROJECT_ID/medisupply/user-service:latest

    - name: Generate secure credentials
      id: creds
      run: |
        # Generate secure random credentials
        DB_USER="medisupply_$(openssl rand -hex 4)"
        DB_PASSWORD="$(openssl rand -base64 32 | tr -d '=/+' | cut -c1-25)"
        JWT_SECRET="$(openssl rand -hex 32)"
        
        echo "db_user=$DB_USER" >> $GITHUB_OUTPUT
        echo "db_password=$DB_PASSWORD" >> $GITHUB_OUTPUT
        echo "jwt_secret=$JWT_SECRET" >> $GITHUB_OUTPUT
        echo "::add-mask::$DB_PASSWORD"  # Mask password in logs
        echo "::add-mask::$JWT_SECRET"   # Mask JWT secret in logs

    - name: Update Kubernetes manifests
      run: |
        # Replace PROJECT_ID in manifests
        sed -i "s/PROJECT_ID/$PROJECT_ID/g" k8s/services/user-service/user-service-deployment.yaml
        sed -i "s/:latest/:$GITHUB_SHA/g" k8s/services/user-service/user-service-deployment.yaml
        
        # Replace database credentials with secure ones
        sed -i "s/__POSTGRES_USER__/${{ steps.creds.outputs.db_user }}/g" k8s/database/postgres-secret.yaml
        sed -i "s/__POSTGRES_PASSWORD__/${{ steps.creds.outputs.db_password }}/g" k8s/database/postgres-secret.yaml
        sed -i "s/__POSTGRES_USER__/${{ steps.creds.outputs.db_user }}/g" k8s/services/user-service/user-service-secret.yaml
        sed -i "s/__POSTGRES_PASSWORD__/${{ steps.creds.outputs.db_password }}/g" k8s/services/user-service/user-service-secret.yaml
        sed -i "s/__JWT_SECRET_KEY__/${{ steps.creds.outputs.jwt_secret }}/g" k8s/services/user-service/user-service-secret.yaml

    - name: Deploy to GKE
      run: |
        # Apply namespace
        kubectl apply -f k8s/namespace.yaml
        
        # Deploy database (if not exists)
        kubectl apply -f k8s/database/
        
        # Wait for database to be ready
        kubectl wait --for=condition=Ready pod -l app=postgres -n medisupply --timeout=300s || echo "Database already running"
        
        # Deploy user-service
        kubectl apply -f k8s/services/user-service/
        
        # Wait for deployment to complete
        kubectl rollout status deployment/user-service-deployment -n medisupply --timeout=600s
        
        # Deploy ingress
        kubectl apply -f k8s/ingress/

    - name: Verify deployment
      run: |
        kubectl get pods -n medisupply
        kubectl get services -n medisupply
        kubectl get ingress -n medisupply

    - name: Get Load Balancer IP
      id: get-ip
      run: |
        # Esperar hasta 5 minutos por la IP externa
        for i in {1..30}; do
          IP=$(kubectl get ingress medisupply-ingress -n medisupply -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          if [ ! -z "$IP" ]; then
            echo "ip=$IP" >> $GITHUB_OUTPUT
            break
          fi
          echo "Esperando IP externa... (intento $i/30)"
          sleep 10
        done

    - name: Update deployment status
      if: steps.get-ip.outputs.ip != ''
      run: |
        echo "🚀 ¡Deploy exitoso!"
        echo "🌐 URL de la aplicación: http://${{ steps.get-ip.outputs.ip }}"
        echo "📚 Documentación: http://${{ steps.get-ip.outputs.ip }}/docs"
        echo "❤️ Health check: http://${{ steps.get-ip.outputs.ip }}/health"
